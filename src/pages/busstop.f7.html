<template>
    <div class="page" data-name="busstop">
        <div class="navbar navbar-large">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="/" class="link" @click="refresh">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">Back</span>
                    </a>
                </div>
                <div class="title-large">
                    <!-- 버스번호 -->
                    <div class="title-large-text bus-title"></div>
                </div>
                <div class="right">
                    <p>
                        <!-- 즐겨찾기 -->
                        <a href="#" class="button open-toast-icon" @click="showToastIcon">
                            <i class="f7-icons">star</i>
                            <span class="if-not-md">Star</span>
                        </a>
                    </p>

                    <p>
                        <!-- 홈버튼 -->
                        <a href="/" data-view=".view-main" class="link home" @click="refresh">
                            <i class="material-icons">home</i>
                            <span class="if-not-md">Home</span>
                        </a>
                    </p>
                </div>
            </div>
        </div>
        <div class="page-content">
            <!-- Timeline -->
            <form class="busData">
                <div class="timeline">
                    <!-- Timeline item with Card -->
                    <div class="timeline-item">
                        <div class="timeline-item-date"><small></small></div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content card">
                            <a href="/reservation/" data-view=".view-main">
                                <div class="button card-header b1"></div>
                            </a>
                            <div class="card-footer card-footer-padding i1">버스정보</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item-date"><small></small></div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content card">
                            <a href="/reservation/" data-view=".view-main">
                                <div class="button card-header b2"></div>
                            </a>
                            <div class="card-footer card-footer-padding i2">버스정보</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item-date"><small></small></div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content card">
                            <a href="/reservation/" data-view=".view-main">
                                <div class="button card-header b3"></div>
                            </a>
                            <div class="card-footer card-footer-padding i3">버스정보</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item-date"><small></small></div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content card">
                            <a href="/reservation/" data-view=".view-main">
                                <div class="button card-header b4"></div>
                            </a>
                            <div class="card-footer card-footer-padding i4">버스정보</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item-date"><small></small></div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content card">
                            <a href="/reservation/" data-view=".view-main">
                                <div class="button card-header b5"></div>
                            </a>
                            <div class="card-footer card-footer-padding i5">버스정보</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item-date"><small></small></div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content card">
                            <a href="/reservation/" data-view=".view-main">
                                <div class="button card-header b6"></div>
                            </a>
                            <div class="card-footer card-footer-padding i6">버스정보</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-item-date"><small></small></div>
                        <div class="timeline-item-divider"></div>
                        <div class="timeline-item-content card">
                            <a href="/reservation/" data-view=".view-main">
                                <div class="button card-header b7"></div>
                            </a>
                            <div class="card-footer card-footer-padding i7">버스정보</div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</template>
<script>
    import {
        Button
    } from 'framework7';
    export default {
        components: {
            Button
        },
        methods: {
            showToastIcon() {
                const self = this;
                var app = self.$app;


                // Create toast
                if (!app.toastIcon) {
                    app.toastIcon = app.toast.create({
                        icon: app.$theme ? '<i class="icons">start</i>' : '<i class="material-icons">start</i>',
                        text: 'I\'m on center',
                        position: 'center',
                        closeTimeout: 1000,
                    });
                }
                // Open it
                app.toastIcon.open();
            },
            refresh: function () {
                setTimeout("location.reload(true);");
            },
            LoginCheck() {
                const self = this;
                var app = self.$app;
                var usersDB = firebase.firestore().collection("users");
                var user = firebase.auth().currentUser;
                var auth = firebase.auth();
                var userEmail;

                // 유저 데이터를 받아서 현재 접속되어 있는 유저의 email 데이터를 받음
                // 받은 email데이터로 userDB의 email에 예약 정보를 저장
                // 버스 상태에 따라(이미 지난 정류장 클릭x) 예약이 가능하게 버튼 활성화

                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // User is signed in.
                        console.log(user.email)
                        userEmail = user.email
                        this.reservation(userEmail)

                    } else {
                        app.dialog.alert("로그인을 해주세요.");
                    }
                });
            },
            reservation(userEmail) {
                var usersDB = firebase.firestore().collection("users");

                return usersDB.doc(userEmail).update({
                    reservation : 1111
                  })
                  .then(function () {
                      console.log("완료")
                  })
                  .catch(function (error) {
                    console.log(error);
                  });
            },
            // 처음 한번만 실행해도 ok
            readDB() {
                var app = self.$app;
                var busDB = firebase.firestore().collection("bus");
                var b1, b2, b3, b4, b5, b6, b7, busTitle, i;
                busDB.doc("7018")
                    .get()
                    .then((doc) => {
                        b1 = doc.data().b1;
                        b2 = doc.data().b2;
                        b3 = doc.data().b3;
                        b4 = doc.data().b4;
                        b5 = doc.data().b5;
                        b6 = doc.data().b6;
                        b7 = doc.data().b7;
                        busTitle = doc.data().bus_num;
                        this.$el.find('.bus-title').text(busTitle + "번");
                        this.$el.find('.b1').text(b1);
                        this.$el.find('.b2').text(b2);
                        this.$el.find('.b3').text(b3);
                        this.$el.find('.b4').text(b4);
                        this.$el.find('.b5').text(b5);
                        this.$el.find('.b6').text(b6);
                        this.$el.find('.b7').text(b7);
                        console.log("첫번째")
                    })
                    .catch(function (error) {
                        console.log("Error getting documents: ", error);
                    });
            },
            readI() {
                var app = self.$app;
                var RbusDB = firebase.firestore().collection("reservationBus");
                var i;

                // i 값을 db에서 읽음
                RbusDB.doc("1111")
                    .get()
                    .then((doc) => {
                        i = doc.data().empty;
                        console.log("두번쨰");
                        this.setBusStop(i); // 세번째
                        this.plusI(i); // 네번째
                        console.log("------------------로테이션 끝----------------------")
                    })
                    .catch(function (error) {
                        console.log("Error getting documents: ", error);
                    });
            },

            setBusStop(i) {

                var app = self.$app;
                var RbusDB = firebase.firestore().collection("reservationBus");


                // 계속해서 5초마다 새로고침하며 클래스에 적용
                for (var j = 1; j < 8; j++) {
                    this.$el.find('.i' + j).text("");
                    console.log("세번쨰")
                }
                this.$el.find('.i' + i).text("1111번");
                console.log("세번쨰 i = " + i)
                console.log("세번쨰 반")

            },
            plusI(i) {

                var app = self.$app;
                var RbusDB = firebase.firestore().collection("reservationBus");
                if (i > 4) {
                    // 값7 오버시 i를 1로 재설정
                    RbusDB.doc("1111").set({
                            empty: 1
                        })
                        .then(function () {
                            console.log("네번째 첫")
                        })
                        .catch(function (error) {
                            console.log(error);
                        });

                } else {
                    // i 값을 +3씩 계속 업데이트 해줌
                    RbusDB.doc("1111").set({
                            empty: i + 3
                        })
                        .then(function () {
                            console.log("네번째 둘")
                        })
                        .catch(function (error) {
                            console.log(error);
                        });

                }
            }
        },
        on: {
            pageAfterOut() {
                const self = this;
                var app = self.$app;


                app.toast.close();

            },
            pageBeforeRemove() {
                const self = this;
                var app = self.$app;
                // Destroy toasts when page removed
                if (app.toastIcon) app.toastIcon.destroy();
            },
        },
        mounted() {
            this.readDB()
            this.readI()
            this.LoginCheck()
            setInterval(() => {
                this.readI()

            }, 5000);
        },

    };
</script>